name: Publish Updater JSON
on:
  workflow_run:
    workflows: ["Release"]
    types: [completed]

jobs:
  publish-updater:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fix git safe.directory
        run: git config --global --add safe.directory '*'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate updater JSON
        id: generate_updater
        run: |
          # Fetch the latest release data
          RELEASE_DATA=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/releases/latest)
          
          VERSION=$(echo "$RELEASE_DATA" | jq -r .tag_name | sed 's/^v//')
          TAG_NAME=$(echo "$RELEASE_DATA" | jq -r .tag_name)
          NOTES=$(echo "$RELEASE_DATA" | jq -r .body)
          PUB_DATE=$(echo "$RELEASE_DATA" | jq -r .published_at)
          echo "tag_name=$TAG_NAME" >> "$GITHUB_OUTPUT"
          
          # Find the .app.tar.gz and its .sig for macOS ARM
          ASSETS_JSON=$(echo "$RELEASE_DATA" | jq -c '.assets')
          
          BUNDLE_URL=$(echo "$ASSETS_JSON" | jq -r '.[] | select(.name | endswith(".app.tar.gz")) | .browser_download_url' | head -1)
          SIG_NAME=$(echo "$ASSETS_JSON" | jq -r '.[] | select(.name | endswith(".app.tar.gz.sig")) | .name' | head -1)
          SIG_URL=$(echo "$ASSETS_JSON" | jq -r '.[] | select(.name | endswith(".app.tar.gz.sig")) | .browser_download_url' | head -1)
          
          if [ -z "$BUNDLE_URL" ] || [ -z "$SIG_URL" ]; then
            echo "ERROR: Could not find .app.tar.gz bundle or signature in release assets"
            echo "Assets found:"
            echo "$ASSETS_JSON" | jq -r '.[].name'
            exit 1
          fi
          
          SIGNATURE=$(curl -fsSL "$SIG_URL" | tr -d '\n')
          
          cat > latest.json << EOF
          {
            "version": "$VERSION",
            "notes": $(echo "$NOTES" | jq -R -s .),
            "pub_date": "$PUB_DATE",
            "platforms": {
              "darwin-aarch64": {
                "signature": "$SIGNATURE",
                "url": "$BUNDLE_URL"
              }
            }
          }
          EOF
          
          # Clean up indentation from heredoc
          python3 -c "import json,sys; d=json.load(open('latest.json')); json.dump(d,open('latest.json','w'),indent=2)"
          
          cat latest.json

      - name: Upload latest.json to release
        uses: softprops/action-gh-release@v2
        with:
          files: latest.json
          tag_name: ${{ steps.generate_updater.outputs.tag_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}