name: Publish Updater JSON
on:
  workflow_run:
    workflows: ["Release"]
    types: [completed]

jobs:
  publish-updater:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fix git safe.directory
        run: git config --global --add safe.directory '*'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate updater JSON
        id: generate_updater
        run: |
          # This script fetches the latest release assets and generates the latest.json file
          # required by Tauri's updater plugin.
          
          # Get the latest release data
          RELEASE_DATA=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/releases/latest)
          
          VERSION=$(echo "$RELEASE_DATA" | jq -r .tag_name | sed 's/^v//')
          TAG_NAME=$(echo "$RELEASE_DATA" | jq -r .tag_name)
          NOTES=$(echo "$RELEASE_DATA" | jq -r .body)
          PUB_DATE=$(echo "$RELEASE_DATA" | jq -r .published_at)
          echo "tag_name=$TAG_NAME" >> "$GITHUB_OUTPUT"
          
          # Initialize the JSON structure
          echo "{" > latest.json
          echo "  \"version\": \"$VERSION\"," >> latest.json
          echo "  \"notes\": $(echo "$NOTES" | jq -R -s .)," >> latest.json
          echo "  \"pub_date\": \"$PUB_DATE\"," >> latest.json
          echo "  \"platforms\": {" >> latest.json
          
          # Process updater bundles by using .sig assets and mapping to bundle asset names.
          ASSETS_JSON=$(echo "$RELEASE_DATA" | jq -c '.assets')
          SIG_NAMES=$(echo "$ASSETS_JSON" | jq -r '.[] | .name | select(endswith(".sig"))')
          FIRST=true

          for SIG_NAME in $SIG_NAMES; do
            BUNDLE_NAME="${SIG_NAME%.sig}"
            BUNDLE_URL=$(echo "$ASSETS_JSON" | jq -r --arg n "$BUNDLE_NAME" '.[] | select(.name == $n) | .browser_download_url' | head -n 1)
            SIG_URL=$(echo "$ASSETS_JSON" | jq -r --arg n "$SIG_NAME" '.[] | select(.name == $n) | .browser_download_url' | head -n 1)

            if [ -z "$BUNDLE_URL" ] || [ -z "$SIG_URL" ]; then
              continue
            fi

            PLATFORM=""
            if [[ "$BUNDLE_NAME" == *"universal.app.tar.gz"* ]]; then
              PLATFORM="darwin-universal"
            elif [[ "$BUNDLE_NAME" == *"aarch64.app.tar.gz"* ]] || [[ "$BUNDLE_NAME" == *"arm64.app.tar.gz"* ]]; then
              PLATFORM="darwin-aarch64"
            elif [[ "$BUNDLE_NAME" == *"x86_64.app.tar.gz"* ]] || [[ "$BUNDLE_NAME" == *"x64.app.tar.gz"* ]]; then
              PLATFORM="darwin-x86_64"
            elif [[ "$BUNDLE_NAME" == *".nsis.zip"* ]] || [[ "$BUNDLE_NAME" == *"windows"* ]]; then
              PLATFORM="windows-x86_64"
            elif [[ "$BUNDLE_NAME" == *".AppImage.tar.gz"* ]] || [[ "$BUNDLE_NAME" == *"linux"* ]]; then
              PLATFORM="linux-x86_64"
            fi

            if [ -z "$PLATFORM" ]; then
              continue
            fi

            SIGNATURE=$(curl -fsSL "$SIG_URL" | tr -d '\n')
            if [ -z "$SIGNATURE" ]; then
              continue
            fi

            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              echo "    ," >> latest.json
            fi

            echo "    \"$PLATFORM\": {" >> latest.json
            echo "      \"signature\": \"$SIGNATURE\"," >> latest.json
            echo "      \"url\": \"$BUNDLE_URL\"" >> latest.json
            echo "    }" >> latest.json
          done
          
          echo "  }" >> latest.json
          echo "}" >> latest.json
          
          cat latest.json

      - name: Upload latest.json to release
        uses: softprops/action-gh-release@v2
        with:
          files: latest.json
          tag_name: ${{ steps.generate_updater.outputs.tag_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}